workflows:
  strmify-ios-build:
    name: Strmify iOS Build
    environment:
      node: latest
      xcode: latest
      groups:
        - EXPO
    scripts:
      - name: Install dependencies
        script: npm install --force
      
      - name: Install Expo CLI
        script: npm install -g @expo/cli@latest --force
      
      - name: Check Expo CLI version
        script: npx expo --version
      
      - name: Extract app version from app.json
        script: |
          if [ -f "app.json" ]; then
            APP_VERSION=$(node -p "JSON.parse(require('fs').readFileSync('app.json', 'utf8')).expo.version")
            APP_NAME=$(node -p "JSON.parse(require('fs').readFileSync('app.json', 'utf8')).expo.name.replace(/[^a-zA-Z0-9]/g, '')")
            
            echo "üì± App Name: $APP_NAME"
            echo "üìã Version: $APP_VERSION"
            echo "APP_VERSION=$APP_VERSION" >> $CM_ENV
            echo "APP_NAME=$APP_NAME" >> $CM_ENV
          else
            echo "‚ö†Ô∏è  app.json not found, using default values"
            echo "APP_VERSION=1.0.0" >> $CM_ENV
            echo "APP_NAME=Strmify" >> $CM_ENV
          fi
      
      - name: Clean and generate iOS project
        script: |
          rm -rf ios android
          npx expo prebuild --platform ios
      
      - name: Install iOS dependencies
        script: |
          cd ios
          pod install
      
      - name: Build with Xcode (unsigned)
        script: |
          cd ios
          WORKSPACE=$(find . -name "*.xcworkspace" -maxdepth 1 | head -1)
          if [ -z "$WORKSPACE" ]; then
            echo "‚ùå No .xcworkspace found"
            exit 1
          fi
          
          SCHEME_NAME=$(basename "$WORKSPACE" .xcworkspace)
          echo "üì± Building scheme: $SCHEME_NAME"
          
          xcodebuild -workspace "$WORKSPACE" \
            -scheme "$SCHEME_NAME" \
            -configuration Release \
            -destination generic/platform=iOS \
            -archivePath "build/$SCHEME_NAME.xcarchive" \
            archive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            DEVELOPMENT_TEAM=""

          mkdir -p "build/Payload"
          cp -r "build/$SCHEME_NAME.xcarchive/Products/Applications/"*.app "build/Payload/"

          APP_BUNDLE=$(ls "build/Payload/" | head -1)
          BASE_NAME="${APP_BUNDLE%.app}"

          echo "üì± App bundle: $APP_BUNDLE"

          # Create versioned IPA name
          IPA_NAME="${APP_NAME}_v${APP_VERSION}"
          
          echo "üì¶ IPA name: $IPA_NAME"

          EXECUTABLE=$(plutil -extract CFBundleExecutable raw "build/Payload/$APP_BUNDLE/Info.plist" 2>/dev/null || echo "$BASE_NAME")
          if [ ! -f "build/Payload/$APP_BUNDLE/$EXECUTABLE" ]; then
            echo "‚ö†Ô∏è  Warning: Executable $EXECUTABLE not found"
          else
            echo "‚úÖ Executable found: $EXECUTABLE"
          fi

          cd build
          zip -r "$IPA_NAME.ipa" Payload/

          if [ -f "$IPA_NAME.ipa" ]; then
            echo "‚úÖ IPA created successfully: $IPA_NAME.ipa"
            echo "üìä IPA size: $(ls -lh "$IPA_NAME.ipa" | awk '{print $5}')"
            echo "üè∑Ô∏è  Full version info: $APP_NAME v$APP_VERSION"
            
            # Create a symlink with a simple name for easier access
            ln -sf "$IPA_NAME.ipa" "latest.ipa"
            echo "üîó Symlink created: latest.ipa -> $IPA_NAME.ipa"
          else
            echo "‚ùå Failed to create IPA"
            exit 1
          fi
    
    artifacts:
      - ios/build/*.ipa
      - ios/build/**/*.xcarchive

  strmify-ios-dev:
    name: Strmify iOS Development Build
    environment:
      node: latest
      xcode: latest
      groups:
        - EXPO
    scripts:
      - name: Install dependencies
        script: npm install --force

      - name: Install Expo CLI
        script: npm install -g @expo/cli@latest --force

      - name: Extract app version from app.json
        script: |
          if [ -f "app.json" ]; then
            APP_VERSION=$(node -p "JSON.parse(require('fs').readFileSync('app.json', 'utf8')).expo.version")
            APP_NAME=$(node -p "JSON.parse(require('fs').readFileSync('app.json', 'utf8')).expo.name.replace(/[^a-zA-Z0-9]/g, '')")
            echo "üì± App Name: $APP_NAME"
            echo "üìã Version: $APP_VERSION"
            echo "APP_VERSION=$APP_VERSION" >> $CM_ENV
            echo "APP_NAME=$APP_NAME" >> $CM_ENV
          else
            echo "‚ö†Ô∏è  app.json not found, using defaults"
            echo "APP_VERSION=1.0.0" >> $CM_ENV
            echo "APP_NAME=Strmify" >> $CM_ENV
          fi

      - name: Clean and generate iOS project
        script: |
          rm -rf ios android
          npx expo prebuild --platform ios

      - name: Install iOS dependencies
        script: |
          cd ios
          pod install

      - name: Build with Xcode (Debug, unsigned)
        script: |
          cd ios
          WORKSPACE=$(find . -name "*.xcworkspace" -maxdepth 1 | head -1)
          SCHEME_NAME=$(basename "$WORKSPACE" .xcworkspace)

          echo "üì± Building development scheme: $SCHEME_NAME"

          xcodebuild -workspace "$WORKSPACE" \
            -scheme "$SCHEME_NAME" \
            -configuration Debug \
            -destination generic/platform=iOS \
            -archivePath "build/$SCHEME_NAME-dev.xcarchive" \
            archive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            DEVELOPMENT_TEAM=""

          mkdir -p build/Payload
          cp -r build/$SCHEME_NAME-dev.xcarchive/Products/Applications/*.app build/Payload/

          APP_BUNDLE=$(ls build/Payload/ | head -1)
          IPA_NAME="${APP_NAME}_Dev_v${APP_VERSION}"

          cd build
          zip -r "$IPA_NAME.ipa" Payload/

          if [ -f "$IPA_NAME.ipa" ]; then
            echo "‚úÖ Development IPA created: $IPA_NAME.ipa"
            ln -sf "$IPA_NAME.ipa" "latest-dev.ipa"
          else
            echo "‚ùå Failed to create Development IPA"
            exit 1
          fi

    artifacts:
      - ios/build/*.ipa

  strmify-android-build:
    name: Strmify Android Production Build
    environment:
      node: latest
      java: 17
      groups:
        - EXPO
        - ANDROID
    scripts:
      - name: Install dependencies
        script: npm install --force

      - name: Install Expo CLI
        script: npm install -g @expo/cli@latest --force

      - name: Extract app version from app.json
        script: |
          if [ -f "app.json" ]; then
            APP_VERSION=$(node -p "JSON.parse(require('fs').readFileSync('app.json', 'utf8')).expo.version")
            APP_NAME=$(node -p "JSON.parse(require('fs').readFileSync('app.json', 'utf8')).expo.name.replace(/[^a-zA-Z0-9]/g, '')")
            VERSION_CODE=$(node -p "JSON.parse(require('fs').readFileSync('app.json', 'utf8')).expo.android?.versionCode || 1")
            
            echo "üì± App Name: $APP_NAME"
            echo "üìã Version: $APP_VERSION"
            echo "üî¢ Version Code: $VERSION_CODE"
            echo "APP_VERSION=$APP_VERSION" >> $CM_ENV
            echo "APP_NAME=$APP_NAME" >> $CM_ENV
            echo "VERSION_CODE=$VERSION_CODE" >> $CM_ENV
          else
            echo "‚ö†Ô∏è  app.json not found, using default values"
            echo "APP_VERSION=1.0.0" >> $CM_ENV
            echo "APP_NAME=Strmify" >> $CM_ENV
            echo "VERSION_CODE=1" >> $CM_ENV
          fi

      - name: Verify Android project exists
        script: |
          if [ ! -d "android" ]; then
            echo "‚ùå Android project not found. Please ensure the android/ directory exists in your repository."
            echo "üí° Consider using 'npx expo run:android' locally first to generate the native project."
            exit 1
          fi
          echo "‚úÖ Android project found"

      - name: Set up Android SDK
        script: |
          echo "üîß Setting up Android SDK paths"
          export ANDROID_HOME=$HOME/Android/Sdk
          export PATH=$PATH:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools
          
          # Accept licenses
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true

      - name: Build production APK and AAB
        script: |
          cd android
          
          echo "üèóÔ∏è  Building production APK and AAB"
          
          # Build release APK (unsigned)
          ./gradlew assembleRelease
          
          # Build release AAB (unsigned)  
          ./gradlew bundleRelease
          
          # Create build output directory
          mkdir -p ../build/android
          
          # Copy and rename APK
          if [ -f "app/build/outputs/apk/release/app-release-unsigned.apk" ]; then
            APK_NAME="${APP_NAME}_v${APP_VERSION}"
            cp "app/build/outputs/apk/release/app-release-unsigned.apk" "../build/android/${APK_NAME}.apk"
            echo "‚úÖ APK created: ${APK_NAME}.apk"
            echo "üìä APK size: $(ls -lh "../build/android/${APK_NAME}.apk" | awk '{print $5}')"
            
            # Create symlink for easy access
            cd ../build/android
            ln -sf "${APK_NAME}.apk" "latest.apk"
            cd ../../android
          fi
          
          # Copy and rename AAB
          if [ -f "app/build/outputs/bundle/release/app-release.aab" ]; then
            AAB_NAME="${APP_NAME}_v${APP_VERSION}"
            cp "app/build/outputs/bundle/release/app-release.aab" "../build/android/${AAB_NAME}.aab"
            echo "‚úÖ AAB created: ${AAB_NAME}.aab"
            echo "üìä AAB size: $(ls -lh "../build/android/${AAB_NAME}.aab" | awk '{print $5}')"
            
            # Create symlink for easy access
            cd ../build/android
            ln -sf "${AAB_NAME}.aab" "latest.aab"
            cd ../../android
          fi
          
          echo "üè∑Ô∏è  Production build info: $APP_NAME v$APP_VERSION (Build $VERSION_CODE)"

    artifacts:
      - build/android/*.apk
      - build/android/*.aab

  strmify-android-dev:
    name: Strmify Android Development Build
    environment:
      node: latest
      java: 17
      groups:
        - EXPO
        - ANDROID
    scripts:
      - name: Install dependencies
        script: npm install --force

      - name: Install Expo CLI
        script: npm install -g @expo/cli@latest --force

      - name: Extract app version from app.json
        script: |
          if [ -f "app.json" ]; then
            APP_VERSION=$(node -p "JSON.parse(require('fs').readFileSync('app.json', 'utf8')).expo.version")
            APP_NAME=$(node -p "JSON.parse(require('fs').readFileSync('app.json', 'utf8')).expo.name.replace(/[^a-zA-Z0-9]/g, '')")
            VERSION_CODE=$(node -p "JSON.parse(require('fs').readFileSync('app.json', 'utf8')).expo.android?.versionCode || 1")
            
            echo "üì± App Name: $APP_NAME"
            echo "üìã Version: $APP_VERSION"
            echo "üî¢ Version Code: $VERSION_CODE"
            echo "APP_VERSION=$APP_VERSION" >> $CM_ENV
            echo "APP_NAME=$APP_NAME" >> $CM_ENV
            echo "VERSION_CODE=$VERSION_CODE" >> $CM_ENV
          else
            echo "‚ö†Ô∏è  app.json not found, using defaults"
            echo "APP_VERSION=1.0.0" >> $CM_ENV
            echo "APP_NAME=Strmify" >> $CM_ENV
            echo "VERSION_CODE=1" >> $CM_ENV
          fi

      - name: Verify Android project exists
        script: |
          if [ ! -d "android" ]; then
            echo "‚ùå Android project not found. Please ensure the android/ directory exists in your repository."
            echo "üí° Consider using 'npx expo run:android' locally first to generate the native project."
            exit 1
          fi
          echo "‚úÖ Android project found"

      - name: Set up Android SDK
        script: |
          echo "üîß Setting up Android SDK paths"
          export ANDROID_HOME=$HOME/Android/Sdk
          export PATH=$PATH:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools
          
          # Accept licenses
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true

      - name: Build development APK
        script: |
          cd android
          
          echo "üèóÔ∏è  Building development APK"
          
          # Build debug APK
          ./gradlew assembleDebug
          
          # Create build output directory
          mkdir -p ../build/android
          
          # Copy and rename debug APK
          if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
            APK_NAME="${APP_NAME}_Dev_v${APP_VERSION}"
            cp "app/build/outputs/apk/debug/app-debug.apk" "../build/android/${APK_NAME}.apk"
            echo "‚úÖ Development APK created: ${APK_NAME}.apk"
            echo "üìä APK size: $(ls -lh "../build/android/${APK_NAME}.apk" | awk '{print $5}')"
            
            # Create symlink for easy access
            cd ../build/android
            ln -sf "${APK_NAME}.apk" "latest-dev.apk"
            cd ../../android
            
            echo "üè∑Ô∏è  Development build info: $APP_NAME v$APP_VERSION (Build $VERSION_CODE)"
          else
            echo "‚ùå Failed to create development APK"
            exit 1
          fi

    artifacts:
      - build/android/*.apk